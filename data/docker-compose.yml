#version: '3.8'
services:
  TS:
    image: jaeyong0212/road_infra_videoprocessing_test:ver.1
    # container_name: ts_container   # ← 가능하면 제거
    networks:
      macvlan_net:
        ipv4_address: 192.168.10.122
    restart: unless-stopped
    volumes:
      - /home/keti/jetson-containers/data/ts:/data   # ← 서비스별 디렉토리 분리 권장
    command: ["bash", "/data/YOLOv8_TS/run_v8_TS.sh"]
    # runtime: nvidia                                # ← 가능하면 제거
    gpus: all                                        # ← 정식 GPU 지정
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }
    healthcheck:
      test: ["CMD", "bash", "-c", "python3 /data/healthcheck.py"]  # 앱에 맞게
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s

  TL:
    image: jaeyong0212/road_infra_videoprocessing_test:ver.1
    networks: { macvlan_net: { ipv4_address: 192.168.10.123 } }
    restart: unless-stopped
    volumes:
      - /home/keti/jetson-containers/data/tl:/data
    command: ["bash", "/data/YOLOv8_TL/run_v8_TL.sh"]
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    logging: { driver: "json-file", options: { max-size: "10m", max-file: "5" } }

  VMS:
    image: jaeyong0212/road_infra_videoprocessing_test:ver.1
    networks: { macvlan_net: { ipv4_address: 192.168.10.124 } }
    restart: unless-stopped                # ← 추가
    volumes:
      - /home/keti/jetson-containers/data/vms:/data
    command: ["bash", "/data/YOLOv8_VMS/run_v8_VMS.sh"]
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    logging: { driver: "json-file", options: { max-size: "10m", max-file: "5" } }

  LCS:
    image: jaeyong0212/road_infra_videoprocessing_test:ver.1
    networks: { macvlan_net: { ipv4_address: 192.168.10.125 } }
    restart: unless-stopped                # ← 추가
    volumes:
      - /home/keti/jetson-containers/data/lcs:/data
    command: ["bash", "/data/YOLOv8_LCS/run_v8_LCS.sh"]
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    logging: { driver: "json-file", options: { max-size: "10m", max-file: "5" } }

networks:
  macvlan_net:
    driver: macvlan
    external: true
